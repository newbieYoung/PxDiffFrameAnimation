<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>富途三周年动画</title>
	<script type="text/javascript" src="../js/fututhreeyear-data.js"></script>
	<style type="text/css">
	body{
		background-color:rgb(222,222,222);
	}
	canvas{
		position:absolute;
		height:100%;
	}
	#yearCanvas{
		z-index:2;
	}
	#threeCanvas{
		z-index:1;
	}
	</style>
</head>
<body>
	<canvas id="yearCanvas" width="640" height="1136"></canvas>
	<canvas id="threeCanvas" width="640" height="1136"></canvas>
	<script type="text/javascript">
		//常量
		var body = document.querySelector('body');
		var width = 640;
		var height = 1136;
		var finishedNum = 0;//整体轮回标识
		var overs = {//结束标识
			year:false,
			three:false
		};
		var workers = {};//worker集合
		var yearTotalImageData = [];//year动画总像素数据
		var threeTotalImageData = [];//three动画总像素差数据
		//year动画canvas
		var yearCanvas = document.querySelector('#yearCanvas');
		var yearContext = yearCanvas.getContext('2d');
		//three动画canvas
		var threeCanvas = document.querySelector('#threeCanvas');
		var threeContext = threeCanvas.getContext('2d');
		var contexts = {
			year:yearContext,
			three:threeContext
		};
		//图片
		var yearImg = new Image();
		yearImg.src = '../images/fututhreeyear/year-final.png';
		yearImg.onload = function(){
			var initImageData = yearContext.getImageData(0, 0, width, height);
			getFrame('year',2,initImageData,yearImg,0,yearPosition,yearDiffHeight,yearFillLength,31);
		};
		var threeImg = new Image();
		threeImg.src = '../images/fututhreeyear/three-final.png';
		threeImg.onload = function(){
			var initImageData = threeContext.getImageData(0, 0, width, height);
			getFrame('three',2,initImageData,threeImg,0,threePosition,threeDiffHeight,threeFillLength,36);
		};
		/**
		 * 还原帧像素数据
		 * @param  {[type]} name          [动画名称]
		 * @param  {[type]} startNo       [还原帧中第一帧序号]
		 * @param  {[type]} initImageData [启始帧像素数据]
		 * @param  {[type]} img           [原图]
		 * @param  {[type]} lheight       [原图启始纵坐标（合并精灵图是纵向排列的）]
		 * @param  {[type]} position      [还原帧位置差数据]
		 * @param  {[type]} diffHeight    [像素差图片的高度]
		 * @param  {[type]} fillLength    [填充255alpha值后的像素差数据长度]
		 * @param  {[type]} length        [还原帧数量]
		 */
		function getFrame(name,startNo,initImageData,img,lheight,position,diffHeight,fillLength,length){
			var imageData = [];//用于存储还原之后的像素差
			var data = [];
		 	for(var i=0;i<length;i++){
		 		var init = document.createElement('canvas');
		 		init.width = width;
		 		init.height = height;
		 		var initContext = init.getContext('2d');
		 		imageData.push(initContext.getImageData(0, 0, width, height));
		 		var no = startNo+i;
		   		var temp = document.createElement('canvas');
				temp.width = width;
				temp.height = diffHeight[no];
				var tempContext = temp.getContext('2d');
				if(diffHeight[no-1]){
					lheight += diffHeight[no-1];
				}
				tempContext.drawImage(img,0,lheight,width,diffHeight[no],0,0,width,diffHeight[no]);
				data.push(tempContext.getImageData(0, 0, temp.width, temp.height).data);
		   	}
		   	var worker = new Worker('../js/fututhreeyear-compute.js');
			workers[name] = worker;
			var workerData = {
				action:'compute',//计算
				imageData:imageData,
				startNo:startNo,
				data:data,
				position:position,
				fillLength:fillLength,
				length:length,
				initImageData:initImageData
			};
			worker.postMessage(workerData);
			worker.onmessage = function(e){
				var msg = e.data;
				if(msg.result==='finished'){
					finishedNum++;
				}else if(msg.result==='step'){
					if(msg.data){
						contexts[name].clearRect(0, 0, width, height);
						contexts[name].putImageData(msg.data, 0, 0, 0, 0, width, height);
					}else{
						overs[name] = true;
					}
					startNo++;
					finishedNum++;
				}
				if(finishedNum===2){//全部数据计算完成
					finishedNum = 0;
					workers['year'].postMessage({
						action:'animate',
						step:startNo
					});
					workers['three'].postMessage({
						action:'animate',
						step:startNo
					});
				}
				if(overs['year']&&overs['three']){//全部动画完成
					workers['year'].terminate();
					workers['three'].terminate();
				}
			};
		}
	</script>
</body>
</html>
